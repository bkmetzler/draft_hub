{% extends 'base.html' %}
{% block title %}{{ doc.title }} · Draft Hub{% endblock %}
{% block content %}
  <div class="card">
    <h1>{{ doc.title }}</h1>
    <p>Tenant: <a href="{{ url_for('tenant_detail', tenant_id=doc.project.tenant.id) }}">{{ doc.project.tenant.name }}</a> · Project: <a href="{{ url_for('project_detail', project_id=doc.project.id) }}">{{ doc.project.name }}</a></p>
    <p>By {{ doc.creator.username }} · Created {{ doc.created_at.strftime('%Y-%m-%d %H:%M UTC') }} · Updated {{ doc.updated_at.strftime('%Y-%m-%d %H:%M UTC') }}</p>
    {% if doc.summary %}
      <p><strong>Summary:</strong> {{ doc.summary }}</p>
    {% endif %}
    <h3>Full Text</h3>
    <pre style="white-space: pre-wrap; background:#f8fafc; padding:1rem; border-radius:4px;">{{ doc.text }}</pre>
  </div>

  <section>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Amendments</h2>
      {% if g.user %}
        <a class="btn" href="{{ url_for('create_amendment', doc_id=doc.id) }}">Propose Amendment</a>
      {% endif %}
    </div>
    {% if amendments %}
      {% for am in amendments %}
        <div class="card">
          <h3>{{ am.title }}</h3>
          <p>Proposed by {{ am.author.username }} on {{ am.created_at.strftime('%Y-%m-%d %H:%M UTC') }} · Status: <strong>{{ am.status }}</strong></p>
          {% if am.description %}
            <p>{{ am.description }}</p>
          {% endif %}
          <p>
            Score: {{ am.score }} · Votes: {{ am.vote_count }} / {{ min_votes_required }} required · Approval: {{ am.approval_percentage }}%
          </p>
          {% if am.has_minimum_votes %}
            <p class="flash success" style="margin-top:0;">Meets minimum vote requirement.</p>
          {% else %}
            {% set remaining = min_votes_required - am.vote_count %}
            <p class="flash warning" style="margin-top:0;">Needs {{ remaining if remaining > 0 else 0 }} more vote(s).</p>
          {% endif %}
          <details>
            <summary>Show proposed text</summary>
            <pre style="white-space: pre-wrap; background:#f1f5f9; padding:1rem; border-radius:4px;">{{ am.proposed_text }}</pre>
          </details>
          {% if am.status == 'open' %}
            {% if g.user %}
              <form method="post" action="{{ url_for('vote', amendment_id=am.id) }}" style="margin-top:1rem; display:flex; gap:0.5rem;">
                <button type="submit" name="value" value="1">Approve</button>
                <button type="submit" class="secondary" name="value" value="-1">Reject</button>
              </form>
            {% else %}
              <p><a href="{{ url_for('login', next=request.path) }}">Log in</a> to vote.</p>
            {% endif %}
          {% else %}
            <p class="flash info" style="margin-top:1rem;">Voting is closed because moderators {{ am.status }} this amendment.</p>
          {% endif %}

          {% if can_moderate and am.status == 'open' %}
            <form method="post" action="{{ url_for('moderate_amendment', amendment_id=am.id) }}" style="margin-top:1rem; display:flex; gap:0.5rem;">
              <button type="submit" name="action" value="accept">Accept Amendment</button>
              <button type="submit" class="secondary" name="action" value="reject">Reject Amendment</button>
            </form>
            <p style="margin-top:0.5rem; font-size:0.9rem; color:#475569;">You are a moderator for this document hierarchy.</p>
          {% elif am.status != 'open' %}
            <p style="margin-top:0.5rem; font-size:0.9rem; color:#475569;">Moderators marked this amendment as <strong>{{ am.status }}</strong>.</p>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>No amendments yet.</p>
    {% endif %}
  </section>
{% endblock %}
